version: '3.8'

services:
  anthropic-proxy:
    build:
      context: .  # 构建上下文为项目根目录（包含 backend/ 和 frontend/）
      dockerfile: Dockerfile
      # 可选：传递构建参数
      args:
        PORT: ${PORT:-8088}
    container_name: anthropic-proxy
    environment:
      # 后端配置
      - API_BASE_URL=${API_BASE_URL:-https://anyrouter.top}
      - SYSTEM_PROMPT_REPLACEMENT=${SYSTEM_PROMPT_REPLACEMENT:-You are Claude Code, Anthropic's official CLI for Claude.}
      - SYSTEM_PROMPT_BLOCK_INSERT_IF_NOT_EXIST=${SYSTEM_PROMPT_BLOCK_INSERT_IF_NOT_EXIST:-false}
      # 服务端口配置
      - PORT=${PORT:-8088}
      # 管理面板配置
      - ENABLE_DASHBOARD=${ENABLE_DASHBOARD:-true}
      - DASHBOARD_API_KEY=${DASHBOARD_API_KEY:-your-secret-api-key-change-me}
      # 调试模式
      - DEBUG_MODE=${DEBUG_MODE:-false}
      # 日志持久化
      - LOG_PERSISTENCE_ENABLED=${LOG_PERSISTENCE_ENABLED:-true}
      - LOG_STORAGE_PATH=${LOG_STORAGE_PATH:-data/logs}
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-7}
      - LOG_DAILY_LIMIT=${LOG_DAILY_LIMIT:-1000}
      # 代理配置（可选）
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
    env_file:
      - env/.env # 如果存在 .env 文件,会自动加载
    volumes:
      # 挂载配置文件（可选）
      - ./env/:/app/env/
      # 持久化日志与数据
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "python", "-c", "from dotenv import load_dotenv; import httpx, os; load_dotenv(dotenv_path='/app/env/.env', override=True); port = os.getenv('PORT', '8088'); r = httpx.get(f'http://localhost:{port}/health', timeout=2); exit(0 if r.status_code == 200 else 1)" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    network_mode: "host" # 使用主机网络模式，适用于 Linux 主机
    # 可选：暴露端口（如果不使用 host 网络模式）
    # ports:
    #   - "${PORT:-8088}:${PORT:-8088}"
