# 需求文档

## 简介

**配置管理改版（Config Management Revamp）** 功能通过引入全面的编辑能力、安全认证和持久化配置存储，增强了现有的配置管理系统。此功能将当前的只读配置查看器转变为功能完善的配置管理界面，允许授权管理员直接从 Web 管理面板修改系统设置。

**目的**：让管理员能够通过 Web 界面管理所有环境变量，具备适当的认证和持久化存储能力。

**价值**：消除手动编辑 .env 文件和重启服务器的需求，提供流畅的配置管理体验并内置安全控制。

## 与产品愿景的一致性

此功能与 AnyRouter 透明代理提供全面 Web 管理面板的目标保持一致。通过 Web 界面启用安全的配置编辑，我们提升了管理体验并降低了运维负担，同时保持了代理服务的轻量级和透明特性。

## 需求

### 需求 1：配置编辑的 API Key 认证

**用户故事**：作为管理员，我希望在编辑配置前使用 DASHBOARD_API_KEY 进行认证，以便只有授权人员才能修改敏感的系统设置。

#### 验收标准

1. WHEN 配置页面加载时 THEN 系统应默认以只读模式显示所有配置字段
2. WHEN 页面显示认证输入框时 THEN 系统应允许用户输入 DASHBOARD_API_KEY
3. WHEN 用户输入有效的 DASHBOARD_API_KEY 并点击"解锁"按钮时 THEN 系统应向后端验证密钥并解锁所有配置字段以供编辑
4. WHEN 用户输入无效的 DASHBOARD_API_KEY 时 THEN 系统应显示错误消息并保持所有字段为只读模式
5. IF 后端环境中未配置 DASHBOARD_API_KEY THEN 系统应显示消息指示编辑功能已永久禁用
6. WHEN 存在有效的认证令牌时 THEN 系统应显示"已认证"徽章和"锁定"按钮以返回只读模式

### 需求 2：全面的配置编辑

**用户故事**：作为已认证的管理员，我希望通过 Web 界面编辑所有环境变量，以便无需手动编辑文件即可管理系统配置。

#### 验收标准

1. WHEN 用户已认证时 THEN 系统应显示所有配置值的可编辑输入字段：
   - API_BASE_URL（文本输入框）
   - SYSTEM_PROMPT_REPLACEMENT（文本域）
   - SYSTEM_PROMPT_BLOCK_INSERT_IF_NOT_EXIST（开关）
   - DEBUG_MODE（开关）
   - PORT（数字输入框）
   - ENABLE_DASHBOARD（开关）
   - DASHBOARD_API_KEY（密码输入框，带显示/隐藏切换）
   - Custom Headers（JSON 编辑器，带验证）
2. WHEN 用户修改任何配置字段时 THEN 系统应立即验证输入格式
3. WHEN 检测到无效输入时 THEN 系统应显示内联验证错误
4. WHEN 用户点击"保存配置"按钮时 THEN 系统应将所有配置更改连同认证令牌发送到后端 API

### 需求 3：持久化配置存储到 .env 文件

**用户故事**：作为管理员，我希望配置更改保存到 .env 文件，以便设置在服务器重启后仍然保持。

#### 验收标准

1. WHEN 后端收到配置更新请求时 THEN 系统应验证 Authorization 头中的 DASHBOARD_API_KEY
2. IF DASHBOARD_API_KEY 无效或缺失 THEN 系统应返回 HTTP 401 Unauthorized
3. IF DASHBOARD_API_KEY 有效 THEN 系统应：
   - 解析新的配置值
   - 读取现有的 .env 文件
   - 更新修改的值，同时保留注释和格式
   - 将更新的内容写回 .env 文件
   - 返回 HTTP 200 和成功消息
4. IF .env 文件写入操作失败 THEN 系统应返回 HTTP 500 和错误消息

### 需求 4：服务重启确认提示

**用户故事**：作为管理员，我希望在保存配置后被提示重启后端服务，以便我了解更改需要重启才能生效。

#### 验收标准

1. WHEN 后端成功将配置保存到 .env 文件时 THEN 系统应返回指示需要重启的响应
2. WHEN 前端收到成功保存的响应时 THEN 系统应显示确认模态框，包含：
   - 成功消息，指示配置已保存
   - 明确警告，说明更改只有在重启后端服务后才会生效
   - 如何重启服务的说明（例如："docker-compose restart backend" 或 "systemctl restart anyrouter"）
   - "确定"按钮以确认消息
3. WHEN 用户点击"确定"按钮时 THEN 系统应关闭模态框并刷新配置显示

### 需求 5：只读模式强制执行

**用户故事**：作为系统管理员，我希望当未配置 DASHBOARD_API_KEY 时，配置页面强制执行只读模式，以便默认保持安全性。

#### 验收标准

1. WHEN 后端检测到 DASHBOARD_API_KEY 为空或未设置时 THEN 系统应在配置 API 响应中返回标志 `api_key_configured: false`
2. WHEN 前端收到 `api_key_configured: false` 时 THEN 系统应：
   - 隐藏认证输入框
   - 显示警告横幅："配置编辑已禁用，因为环境中未配置 DASHBOARD_API_KEY"
   - 保持所有配置字段为只读模式
   - 禁用"保存配置"按钮
3. IF DASHBOARD_API_KEY 已配置但用户未认证 THEN 系统应显示认证输入框并保持字段为只读，直到认证成功

## 非功能性需求

### 代码架构与模块化

- **单一职责原则**：将认证逻辑、配置持久化逻辑和验证逻辑分离到不同的模块
- **模块化设计**：为认证输入、配置字段编辑器和重启确认模态框创建可复用组件
- **依赖管理**：最小化认证和配置编辑组件之间的耦合
- **清晰接口**：在前端和后端之间定义清晰的配置管理 API 契约

### 性能

- 配置读取应在 200ms 内完成
- 配置写入应在 500ms 内完成（包括文件 I/O）
- 前端应对验证检查进行防抖处理以避免过多的 API 调用

### 安全性

- DASHBOARD_API_KEY 应仅通过 Authorization 头传输（绝不在 URL 或查询参数中）
- 后端应为每个配置写入操作验证 API 密钥
- 当用户锁定界面时，前端应从内存中清除认证令牌
- 密码字段应使用安全输入类型，带显示/隐藏切换
- 配置更改应被记录以供审计

### 可靠性

- .env 文件写入操作应使用原子写入（写入临时文件 + 重命名）以防止损坏
- 后端应在进行更改前创建 .env 的备份
- 系统应优雅地处理文件权限错误并提供清晰的错误消息

### 可用性

- 认证输入框应在页面加载时自动获得焦点
- 表单验证应提供即时反馈，无需提交
- 成功和错误消息应清晰、简洁且可操作
- 配置字段应包含解释其用途的有用提示
- 自定义头的 JSON 编辑器应提供语法高亮和自动格式化
